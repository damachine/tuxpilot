<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuxPilot Chat Interface</title>
    <link rel="stylesheet" href="/css/tuxpilot.css">
    <style>
        /* Page-specific overrides only */
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/" class="logo">üêß TuxPilot</a>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/config" class="nav-link">Configuration</a>
                <a href="/api" class="nav-link">API Docs</a>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-top">
                    <h3>Conversations</h3>
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark/Light Theme">
                        üåô
                    </button>
                </div>
                <button class="new-session-btn" onclick="createNewSession()">
                    ‚ú® New conversation
                </button>
            </div>
            <div class="sessions-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-title" id="chatTitle">New conversation</div>
                <div class="agent-status">
                    <span class="agent-badge">System</span>
                    <span class="agent-badge">Security</span>
                    <span class="agent-badge">Package</span>
                    <span class="agent-badge">Network</span>
                    <span class="agent-badge">Performance</span>
                </div>
            </div>

            <div class="chat-messages" id="messagesContainer">
                <!-- Messages will be displayed here -->
            </div>

            <div class="welcome-message" id="welcomeScreen">
                <h3>Welcome to TuxPilot</h3>
                <p>Your intelligent Linux system assistant. Ask me anything about your system, security, packages, or performance.</p>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            </div>

            <div class="chat-input-container">
                <form class="chat-input-form" onsubmit="sendMessage(event)">
                    <textarea
                        class="chat-input"
                        id="messageInput"
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <button type="submit" class="send-btn" id="sendButton">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const AUTH_TOKEN = 'demo-token'; // In production, this would come from authentication

        let currentSessionId = null;
        let conversations = [];

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('tuxpilot-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            console.log('Theme initialized:', savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('tuxpilot-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Example prompts functionality
        function useExamplePrompt(prompt) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = prompt;
            messageInput.focus();
            // Auto-resize the textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        }

        // Initialize the chat interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadConversations();
            setupInputHandlers();
        });
        
        function setupInputHandlers() {
            const messageInput = document.getElementById('messageInput');

            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage(e);
                    }
                });

                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                });
            }
        }
        
        async function makeRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                console.log(`Making ${method} request to ${endpoint}`, body ? body : '');
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();

                if (!response.ok) {
                    console.error(`HTTP ${response.status}:`, data);
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                console.log(`Response from ${endpoint}:`, data);
                return data;
            } catch (error) {
                console.error('API request failed:', error);
                if (!error.message.includes('HTTP')) {
                    showError(`Network error: ${error.message}`);
                }
                throw error;
            }
        }
        
        async function loadConversations() {
            try {
                const data = await makeRequest('/api/chat/sessions');
                conversations = data.sessions || [];
                renderConversations();
            } catch (error) {
                console.error('Failed to load conversations:', error);
                showError('Failed to load chat conversations');
            }
        }

        function renderConversations() {
            const conversationsList = document.getElementById('conversationsList');

            if (!conversationsList) return;

            if (conversations.length === 0) {
                conversationsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 14px;">No conversations yet</div>';
                return;
            }

            conversationsList.innerHTML = conversations.map(conversation => {
                const title = conversation.message_count > 0 ?
                    `Chat ${conversation.chat_id.substring(0, 8)}...` :
                    'New conversation';

                return `
                    <div class="conversation-item ${conversation.chat_id === currentSessionId ? 'active' : ''}"
                         onclick="selectConversation('${conversation.chat_id}')">
                        <div class="conversation-title">${title}</div>
                        <div class="conversation-time">${formatRelativeTime(conversation.created_at)}</div>
                    </div>
                `;
            }).join('');
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));

            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}d ago`;
            return date.toLocaleDateString();
        }
        
        async function createNewSession() {
            try {
                const data = await makeRequest('/api/chat/session', 'POST', {
                    execution_mode: 'supervised'
                });

                if (data.chat_id) {
                    currentSessionId = data.chat_id;
                    await loadConversations();
                    selectConversation(data.chat_id);
                    showSuccess('New conversation started');
                } else {
                    throw new Error('No chat_id received from server');
                }
            } catch (error) {
                console.error('Failed to create session:', error);
                showError('Failed to create new conversation');
                throw error; // Re-throw so calling code can handle it
            }
        }

        async function selectConversation(sessionId) {
            currentSessionId = sessionId;
            renderConversations();

            // Show chat header and hide welcome screen
            const chatHeader = document.getElementById('chatHeader');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatTitle = document.getElementById('chatTitle');

            if (chatHeader) chatHeader.style.display = 'block';
            if (welcomeScreen) welcomeScreen.style.display = 'none';
            if (chatTitle) chatTitle.textContent = `Conversation ${sessionId.substring(0, 8)}...`;

            // Clear current messages and load chat history
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) messagesContainer.innerHTML = '';

            await loadChatHistory(sessionId);
        }
        
        async function loadChatHistory(sessionId) {
            try {
                const data = await makeRequest(`/api/chat/${sessionId}/history`);
                const messages = data.messages || [];
                console.log('Loaded chat history:', messages.length, 'messages');
                renderMessages(messages);
            } catch (error) {
                console.error('Failed to load chat history:', error);
                // Start with empty conversation
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }
                showError('Failed to load chat history');
            }
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('messagesContainer');

            if (messages.length === 0) {
                messagesContainer.innerHTML = '';
                return;
            }

            messagesContainer.innerHTML = messages.map(message => {
                // Handle different sender formats from API
                let role, displayName;
                if (message.sender === 'User') {
                    role = 'user';
                    displayName = 'You';
                } else if (typeof message.sender === 'object' && message.sender.Agent) {
                    role = 'assistant';
                    displayName = 'AI';
                } else {
                    role = 'assistant';
                    displayName = 'AI';
                }

                return `
                    <div class="message ${role}">
                        <div class="message-avatar">${displayName}</div>
                        <div class="message-content">
                            ${escapeHtml(message.content)}
                            <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            scrollToBottom();
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        async function sendMessage(event) {
            event.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // If no session exists, create one
            if (!currentSessionId) {
                try {
                    await createNewSession();
                    if (!currentSessionId) {
                        showError('Failed to create chat session');
                        return;
                    }
                } catch (error) {
                    showError('Failed to create chat session');
                    return;
                }
            }

            // Clear input and disable send button
            messageInput.value = '';
            messageInput.style.height = 'auto';
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            // Hide welcome screen if visible
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen && welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                const chatHeader = document.getElementById('chatHeader');
                if (chatHeader) chatHeader.style.display = 'block';
            }

            // Add user message to chat
            addMessageToChat('user', message);

            // Show typing indicator
            showTypingIndicator();

            try {
                const data = await makeRequest('/api/chat', 'POST', {
                    message: message,
                    chat_id: currentSessionId
                });

                hideTypingIndicator();

                if (data.response) {
                    addMessageToChat('assistant', data.response);
                    // Update the current session's chat_id if it was created during this request
                    if (data.chat_id && data.chat_id !== currentSessionId) {
                        currentSessionId = data.chat_id;
                        renderConversations();
                    }
                } else {
                    addMessageToChat('assistant', 'Sorry, I received an empty response. Please try again.');
                }

            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', 'Sorry, I encountered an error processing your request. Please try again.');
            } finally {
                sendButton.disabled = false;
            }
        }
        
        function addMessageToChat(role, content) {
            const messagesContainer = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-avatar">${role === 'user' ? 'You' : 'AI'}</div>
                <div class="message-content">
                    ${escapeHtml(content)}
                    <div class="message-time">${formatMessageTime(new Date().toISOString())}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            typingDiv.style.display = 'flex';

            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
            
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        function showSuccess(message) {
            const chatMessages = document.getElementById('chatMessages');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            chatMessages.appendChild(successDiv);
            scrollToBottom();

            setTimeout(() => successDiv.remove(), 3000);
        }

        // Theme management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update toggle button icon
            const toggleBtn = document.querySelector('.theme-toggle-btn');
            toggleBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;

            html.setAttribute('data-theme', savedTheme);

            // Update toggle button icon
            const toggleBtn = document.querySelector('.theme-toggle-btn');
            if (toggleBtn) {
                toggleBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadConversations();

            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });
    </script>
</body>
</html>
